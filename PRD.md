# 附件批量重命名插件 PRD

## 1. 项目背景
开发一款**飞书多维表格边栏插件**，用于对多维表格中附件字段的文件进行批量重命名。主要场景是用户通过插件批量处理附件名称，支持替换、追加、自动序号等功能，极大地提高文件整理效率。

## 2. 核心功能
### 2.1 整体架构
- **运行环境**: 飞书多维表格边栏插件
- **主要界面**: 选项卡式布局，分为"替换"、"追加"等功能模块（自动序号作为规则项，不单独成页）。
- **操作范围**: 用户可选择作用范围，并选择要处理的附件字段（仅对该列生效）。
- **当前阶段重点**: 仅实现 **"替换"** 和 **"追加"**（不做 AI 重命名）。

### 2.2 功能模块详解

#### A. 替换模式 (Replace)
- **描述**: 舍弃原文件名，使用全新的命名规则。
- **规则配置**:
  - **新名称模板**: 支持输入固定文本（作用于文件名主体，保留原扩展名）。
  - **变量支持**: 必须支持插入“自动序号”及自定义“字段值”。

#### B. 追加模式 (Append)
- **描述**: 保留原文件名，在特定位置添加字符（保留原扩展名）。
- **位置控制**:
  - **在名称前 (Prepend)**: 添加到文件名开头。
  - **在名称后 (Append)**: 添加到文件名末尾（扩展名之前）。
  - **指定位置 (Insert)**: 指定索引位置插入（索引只计算文件名主体，不包含扩展名）。
- **追加内容配置**:
  - **组合逻辑**: 支持 `[前面字符] + [自动序号] + [后面字符]` 的组合方式。
  - **前面字符**: 自定义文本字符串（支持变量）。
  - **自动序号**:
    - **开始序号**: 设置起始数字（如 1）。
    - **序号类型**: 支持阿拉伯数字。
    - **固定位数**: 支持补零（如设置2位，则1显示为01）。
  - **后面字符**: 自定义文本字符串。

#### C. 变量与字段支持
- **自动序号**: 动态生成的序列号；每条记录内单独生成，顺序按该记录中附件原始顺序，每条记录从开始序号重新计数。
- **自定义字段**: 支持读取当前记录的其他字段值（如文本字段、数字字段等），作为前缀或后缀的一部分。通过 Base JS SDK 获取字段数据。

### 2.3 交互与预览
- **实时预览**: 用户调整配置时，底部列表实时显示“原文件名”与“新文件名”的对比。
- **差异高亮**: 新文件名相对于旧文件名的变化部分应予以视觉高亮（如灰色 vs 黑色/高亮色）。
- **操作反馈**: 清晰的“开始重命名”按钮。

### 2.4 作用范围与附件字段
- **附件字段**: 用户必须选择一个附件字段，仅对该列生效。
- **作用范围**: 由用户选择，例如：全表、当前视图、已选记录。

## 3. UI/UX 设计规范
基于提供的原型图参考：
- **布局**: 
  - 顶部为一级 Tab 栏（替换、追加）。
  - 参数区提供“作用范围”与“附件字段”选择器。
  - 中部为参数配置区，使用卡片式或分组容器包裹。
    - “追加”模式下，参数区包含子操作栏： `Tt 固定文本`、`+1 自动序号`、`① 文件属性`，以及位置选择器（`|< 在名称前`、`^ 指定位置`、`>| 在名称后`）。
  - 底部为文件列表预览区。
- **样式**:
  - 现代简洁风格。
  - 激活状态使用醒目颜色（参考图中的粉红色/紫红色）。
  - 输入框和下拉菜单需对齐整齐。

## 4. 技术方案

### 4.1 技术栈
- **框架**: React（使用飞书官方 React 模板）
- **SDK**: `@lark-base-open/js-sdk`（与多维表格交互）
- **UI 组件**: 飞书 Semi Design 或自定义组件
- **构建工具**: Vite
- **部署方式**: 纯前端静态部署即可（如 GitHub Pages 提供运行地址）

### 4.2 文件结构
```
src/
├── App.tsx              # 主应用组件
├── index.tsx            # 入口文件
├── components/          # UI 组件
│   ├── TabBar.tsx       # 顶部选项卡
│   ├── ReplaceMode.tsx  # 替换模式配置
│   ├── AppendMode.tsx   # 追加模式配置
│   └── PreviewList.tsx  # 文件预览列表
├── hooks/               # 自定义 Hooks
│   └── useTableData.ts  # 获取表格数据
├── utils/               # 工具函数
│   └── renamer.ts       # 重命名核心算法
└── styles/              # 样式文件
    └── main.css
```

### 4.3 核心数据流
1. **初始化**: 通过 `bitable.base.getActiveTable()` 获取当前表格
2. **选择附件字段**: 用户选择要操作的附件字段
3. **选择作用范围**: 用户选择本次操作范围，得到目标记录列表
4. **获取附件数据**: 通过 SDK 读取附件字段的文件列表
5. **配置重命名规则**: 用户在界面配置命名规则
6. **实时预览**: 根据规则生成新文件名预览
7. **执行重命名**: 调用 SDK 更新附件字段值

### 4.4 关键 API 使用
```typescript
import { bitable } from '@lark-base-open/js-sdk';

// 获取当前表格
const table = await bitable.base.getActiveTable();

// 获取字段列表
const fieldList = await table.getFieldMetaList();

// 获取附件字段数据
const attachmentField = await table.getField(fieldId);
const cellValue = await attachmentField.getValue(recordId);

// 更新附件字段（重命名）
await attachmentField.setValue(recordId, newAttachmentValue);
```

## 5. 开发路径
1. **PRD 确认**: 也就是本文档。
2. **项目初始化**: 使用飞书 React 模板创建项目。
3. **UI 开发**: 1:1 还原原型图布局，遵循飞书设计规范。
4. **数据层开发**: 实现与多维表格的数据交互。
5. **逻辑开发**: 实现文件名解析、拼接与序号生成算法。
6. **部署**: 纯前端静态部署（如 GitHub Pages）并配置运行地址。
7. **联调测试**: 在多维表格中实际测试附件重命名功能。

## 6. 注意事项
- 附件重命名本质上是修改附件字段的 `name` 属性，不会改变文件内容
- 扩展名保持不变（只改文件名主体）
- 同名文件冲突时，自动添加后缀区分（如 `_1`、`_2`）
- 操作前应提示用户确认，避免误操作
- 支持撤销：保存操作前文件名，仅对最近一次批量重命名生效
